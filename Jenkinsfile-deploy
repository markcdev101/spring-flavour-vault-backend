pipeline {
    agent any

    environment {
        KUBE_NAMESPACE = "app"  // Specify your Kubernetes namespace
        KUBECONFIG = "/var/lib/jenkins/.kube/config"  // Path to your kubeconfig file
        DOCKER_IMAGE_NAME = "markcdev101docker/d3k7m5s9r4p2g2:14"  // Use the latest image
    }

    stages {
        stage('Manual Approval for Deployment') {
            steps {
                script {
                    echo "Awaiting manual approval for deployment..."
                    input message: 'Approve Deployment?', ok: 'Deploy'
                }
            }
        }

        stage('Deploy Service to Kubernetes') {
            steps {
                script {
                    echo "Deploying service to Kubernetes..."
                    sh "kubectl apply -f springboot-service.yaml -n ${KUBE_NAMESPACE}"
                }
            }
        }

        stage('Deploy Application to Kubernetes') {
            steps {
                script {
                    echo "Deploying application to Kubernetes..."
                    sh "kubectl apply -f springboot-statefulset.yaml -n ${KUBE_NAMESPACE}"  // Changed to use the StatefulSet YAML
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment..."
                    def statefulSetCheck = sh(script: "kubectl rollout status statefulset/flavourvault-backend -n ${KUBE_NAMESPACE}", returnStdout: true).trim()
                    echo "StatefulSet status:\n${statefulSetCheck}"
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
        }
        success {
            echo "Deployment to Kubernetes was successful."
        }
        failure {
            echo "Deployment to Kubernetes failed."
        }
    }
}
